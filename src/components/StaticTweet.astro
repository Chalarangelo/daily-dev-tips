---
import moment from 'moment';
import { TwitterClient } from 'twitter-api-client';
const twitterClient = new TwitterClient({
  apiKey: import.meta.env.PUBLIC_TWITTER_API_KEY,
  apiSecret: import.meta.env.PUBLIC_TWITTER_API_SECRET,
  accessToken: import.meta.env.PUBLIC_TWITTER_ACCESS_TOKEN,
  accessTokenSecret: import.meta.env.PUBLIC_TWITTER_ACCESS_TOKEN_SECRET
});

const { id } = Astro.props;

const data = await twitterClient.tweets.statusesShow({
      id: id,
      tweet_mode: 'extended',
    });

let { full_text } = data;

if(data.in_reply_to_screen_name) {
  full_text = full_text.replace(`@${data.in_reply_to_screen_name}`, '');
}

data.entities.urls.forEach(url => {
  full_text = full_text.replace(url.url, `<a rel="noreferrer noopener" target="_blank" href="${url.url}">${url.display_url}</a>`);
});

data.entities.user_mentions.forEach(mention => {
  full_text = full_text.replace(`@${mention.screen_name}`, `<a rel="noreferrer noopener" target="_blank" href="https://twitter.com/${mention.screen_name}">@${mention.screen_name}</a>`);
});

data.entities?.hashtags.forEach(hashtag => {
  full_text = full_text.replace(`#${hashtag.text}`, `<a rel="noreferrer noopener" target="_blank" href="https://twitter.com/hashtag/${hashtag.text}">#${hashtag.text}</a>`);
});

if(data.entities.media) {
    data.entities.media.forEach(media => {
    full_text = full_text.replace(media.url, '');
    });
}

const date = new Date(data.created_at.replace(/^\w+ (\w+) (\d+) ([\d:]+) \+0000 (\d+)$/,
        "$1 $2 $4 $3 UTC"))

const parsedDate = moment(date).calendar();
---
<blockquote class="max-w-md mx-auto font-xs bg-white flex flex-col transition-all	 rounded-md shadow-md hover:shadow-lg ">
  {data.entities?.media?.length &&
    <div>
      <img class="w-full rounded-t-md" src={data.entities.media[0].media_url_https} alt="unknown tweet media content">
    </div>
  }

    <div class="p-4 flex items-center">
      <img class="rounded-full h-10" src={data.user.profile_image_url_https} alt={`${data.user.name} profile image`} />
      <div class="mx-4 flex-1">
        <div class="text-gray-900 font-bold text-base">
          {data.user.name}
        </div>
        <div class="text-gray-500 transition-colors hover:text-pink-700">
          <a rel="noreferrer noopener" target="_blank" href={`https://twitter.com/${data.user.screen_name}`}>
          @{data.user.screen_name}
          </a>
        </div>
      </div>
      <div>
        ðŸ¦‰
      </div>
    </div>
    <div class="prose px-4 mb-4">
      {full_text}
    </div>
    <div class="text-gray-400 text-sm px-4">
      {parsedDate}
    </div>

    <div class="flex justify-between text-gray-400 ">
      <a rel="noreferrer noopener" target="_blank" href={`https://twitter.com/intent/tweet?in_reply_to=${data.id_str}`} class="p-4 transition-colors hover:text-pink-700">
        Reply
      </a>
      <a rel="noreferrer noopener" target="_blank" href={`https://twitter.com/intent/retweet?tweet_id=${data.id_str}`} class="p-4 transition-colors hover:text-pink-700">
        Retweet
      </a>
      <a rel="noreferrer noopener" target="_blank" href={`https://twitter.com/intent/like?tweet_id=${data.id_str}`} class="p-4 transition-colors hover:text-pink-700">
        Like
      </a>
    </div>
</blockquote>